name: Deploy to Raspberry Pi

# Uruchom, gdy wpadnie commit na branch 'main'
on:
  workflow_run:
    workflows: ["Django CI"]  # <--- Tu wpisz DOKÅADNÄ„ nazwÄ™ workflowu z testami (tÄ™ co widzisz na liÅ›cie)
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    # UÅ¼yj agenta zainstalowanego na Malince
    runs-on: self-hosted

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # Krok 0: Wypisz debuggowo, gdzie jesteÅ›my
      - name: Check location
        run: |
          echo "ðŸ¤– Agent dziaÅ‚a jako uÅ¼ytkownik: $(whoami)"
          echo "ðŸ“‚ ÅšcieÅ¼ka robocza: /home/bartosz/animalLogic"

      # Krok 1: PrzejdÅº do folderu i zaktualizuj kod
      - name: Pull latest code
        run: |
          cd /home/bartosz/animalLogic
          
          echo "ðŸ”„ Pobieranie zmian z GitHuba..."
          # Fetch i Reset Hard gwarantujÄ…, Å¼e kod bÄ™dzie 1:1 jak na GitHubie
          git fetch origin
          git reset --hard origin/main

      # Krok 2: Przebuduj kontenery (Build)
      - name: Rebuild Docker Containers
        run: |
          cd /home/bartosz/animalLogic
          
          echo "ðŸ³ Restartowanie kontenerÃ³w..."
          # Down usuwa stare, Up --build tworzy nowe
          docker compose down
          docker compose up -d --build

      # Krok 3: Migracja bazy danych
      - name: Migrate Database
        run: |
          cd /home/bartosz/animalLogic
          
          echo "ðŸ—„ï¸ Aktualizacja bazy danych..."
          # Wykonaj migracje wewnÄ…trz kontenera 'web'
          docker compose exec -T web python manage.py migrate

      # Krok 4: Pliki statyczne (CSS/JS)
      - name: Collect Static Files
        run: |
          cd /home/bartosz/animalLogic
          
          echo "ðŸŽ¨ Zbieranie plikÃ³w statycznych..."
          docker compose exec -T web python manage.py collectstatic --noinput

      - name: Success Message
        run: echo "âœ… WdroÅ¼enie zakoÅ„czone sukcesem! Strona powinna dziaÅ‚aÄ‡."