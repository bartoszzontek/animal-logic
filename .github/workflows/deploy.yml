name: Deploy to Raspberry Pi

on:
  workflow_run:
    workflows: ["Django CI"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:

      - name: Check location + system stats (BEFORE)
        run: |
          echo "ğŸ¤– Agent user: $(whoami)"
          echo "ğŸ“‚ Working dir: /home/bartosz/animal-logic"
          echo "â±ï¸ Uptime:"
          uptime
          echo "ğŸ§  RAM:"
          free -h
          echo "ğŸ’¾ Disk:"
          df -h
          echo "ğŸ³ Docker stats:"
          docker stats --no-stream || true

      - name: Pull latest code
        run: |
          cd /home/bartosz/animal-logic
          echo "ğŸ”„ Pulling code..."
          git fetch origin
          git reset --hard origin/main

      - name: Rebuild Docker Containers
        run: |
          cd /home/bartosz/animal-logic
          echo "ğŸ³ Restarting containers..."
          docker compose down
          docker compose up -d --build

      - name: Migrate Database
        run: |
          cd /home/bartosz/animal-logic
          echo "ğŸ—„ï¸ Running migrations..."
          docker compose exec -T web python manage.py migrate

      - name: Collect Static Files
        run: |
          cd /home/bartosz/animal-logic
          echo "ğŸ¨ Collecting static..."
          docker compose exec -T web python manage.py collectstatic --noinput

      - name: System stats (AFTER)
        run: |
          echo "â±ï¸ Uptime:"
          uptime
          echo "ğŸ§  RAM:"
          free -h
          echo "ğŸ’¾ Disk:"
          df -h
          echo "ğŸ³ Docker stats:"
          docker stats --no-stream || true

      - name: Success Message
        run: echo "âœ… WdroÅ¼enie zakoÅ„czone sukcesem! Strona powinna dziaÅ‚aÄ‡."